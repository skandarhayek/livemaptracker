<!DOCTYPE html>
<html>
  <head>
    <title>CDT Live Tracker</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="icon" type="image/x-icon" href="public/favicon.ico" />
    <style>
      #map {
        height: 100vh;
        width: 100vw;
        margin: -8px;
      }
      .leaflet-marker-icon {
        background-color: transparent;
        border: none;
        box-shadow: none;
      }
      .leaflet-div-icon {
        background-color: transparent !important;
      }
      .legend {
        padding: 6px 8px;
        font: 14px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
      }
      .legend h4 {
        margin: 0 0 5px;
        color: #777;
      }
      .legend-content i {
        width: 18px;
        height: 3px;
        float: left;
        margin: 8px 8px 0 0;
        opacity: 0.7;
      }
      #progress-container {
        position: absolute;
        bottom: 10px;
        left: 10px;
        width: 250px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        padding: 6px 12px;
        font-family: Arial, sans-serif;
        font-size: 14px;
        z-index: 1000;
      }
      #progress-bar {
        width: 100%;
        height: 14px;
        background-color: #eee;
        border-radius: 5px;
        overflow: hidden;
        margin-top: 6px;
      }
      #progress-fill {
        height: 100%;
        background-color: #4caf50;
        width: 0%;
        transition: width 0.3s ease;
      }
      .state-progress {
        margin-top: 8px;
        font-size: 12px;
      }
      .state-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2px;
      }
      .state-bar {
        width: 100%;
        height: 10px;
        background-color: #eee;
        border-radius: 3px;
        overflow: hidden;
      }
      .state-fill {
        height: 100%;
        width: 0%;
        transition: width 0.3s ease;
      }
      .nm-fill {
        background-color: #ff5733;
      }
      .co-fill {
        background-color: #33ff57;
      }
      .wy-fill {
        background-color: #ff33f6;
      }
      .mt-fill {
        background-color: #33fff6;
      }

      @media (max-width: 768px) {
        .leaflet-marker-icon.fas {
          font-size: 32px !important;
        }

        .leaflet-div-icon div {
          width: 12px !important;
          height: 12px !important;
          border-width: 3px !important;
        }

        .legend {
          font-size: 16px !important;
        }

        .legend h4 {
          font-size: 18px !important;
        }

        #progress-container {
          width: calc(100% - 40px);
          font-size: 16px;
          margin: 10px;
          left: 0;
        }

        #progress-bar {
          height: 18px;
        }

        .state-progress {
          margin-top: 12px;
          font-size: 14px;
        }

        .state-bar {
          height: 14px;
        }

        .leaflet-popup-content {
          font-size: 16px !important;
          line-height: 1.5 !important;
        }
      }

      .mobile-toggle {
        display: none;
        position: absolute;
        bottom: 20px;
        width: 40px;
        height: 40px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        cursor: pointer;
        font-size: 20px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #555;
      }

      #progress-toggle {
        left: 10px;
      }

      #legend-toggle {
        right: 10px;
      }

      @media (max-width: 768px) {
        .mobile-toggle {
          display: flex;
        }

        #progress-container {
          display: none;
          width: calc(100% - 40px);
          max-height: 60vh;
          overflow-y: auto;
        }

        #progress-container.visible {
          display: block;
        }

        .legend {
          display: none;
          max-height: 60vh;
          overflow-y: auto;
        }

        .legend.visible {
          display: block;
        }
      }

      .minimize-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 24px;
        height: 24px;
        background: transparent;
        border: none;
        cursor: pointer;
        color: #666;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        border-radius: 3px;
      }

      .minimize-btn:hover {
        background: rgba(0, 0, 0, 0.1);
      }

      @media (max-width: 768px) {
        .mobile-toggle.hidden {
          display: none;
        }
      }

      .mobile-toggle,
      .minimize-btn {
        display: none;
      }

      @media (max-width: 768px) {
        .mobile-toggle {
          display: flex;
          position: absolute;
          bottom: 20px;
          width: 40px;
          height: 40px;
          background: white;
          border: 1px solid #ccc;
          border-radius: 4px;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
          z-index: 1000;
          cursor: pointer;
          font-size: 20px;
          padding: 0;
          align-items: center;
          justify-content: center;
          color: #555;
        }

        .minimize-btn {
          display: flex;
          position: absolute;
          top: 8px;
          right: 8px;
          width: 24px;
          height: 24px;
          background: transparent;
          border: none;
          cursor: pointer;
          color: #666;
          font-size: 18px;
          align-items: center;
          justify-content: center;
          padding: 0;
          border-radius: 3px;
        }

        .mobile-toggle.hidden {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div id="progress-container">
      <button class="minimize-btn" aria-label="Minimize Progress">
        <i class="fas fa-minus"></i>
      </button>
      <div>
        Overall Progress: <span id="progress-percent">0%</span>
        <div id="progress-bar">
          <div id="progress-fill"></div>
        </div>
      </div>

      <div class="state-progress">
        <div class="state-label">
          <span>New Mexico</span>
          <span id="nm-percent">0%</span>
        </div>
        <div class="state-bar">
          <div class="state-fill nm-fill" id="nm-fill"></div>
        </div>
      </div>

      <div class="state-progress">
        <div class="state-label">
          <span>Colorado</span>
          <span id="co-percent">0%</span>
        </div>
        <div class="state-bar">
          <div class="state-fill co-fill" id="co-fill"></div>
        </div>
      </div>

      <div class="state-progress">
        <div class="state-label">
          <span>Wyoming</span>
          <span id="wy-percent">0%</span>
        </div>
        <div class="state-bar">
          <div class="state-fill wy-fill" id="wy-fill"></div>
        </div>
      </div>

      <div class="state-progress">
        <div class="state-label">
          <span>Montana</span>
          <span id="mt-percent">0%</span>
        </div>
        <div class="state-bar">
          <div class="state-fill mt-fill" id="mt-fill"></div>
        </div>
      </div>
    </div>
    <button
      id="progress-toggle"
      class="mobile-toggle"
      aria-label="Toggle Progress"
    >
      <i class="fas fa-chart-line"></i>
    </button>
    <button id="legend-toggle" class="mobile-toggle" aria-label="Toggle Legend">
      <i class="fas fa-map"></i>
    </button>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-omnivore/leaflet-omnivore.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const tracksLayer = L.layerGroup();
        const markersLayer = L.layerGroup();
        const cdtLayer = L.layerGroup();

        const map = L.map("map").setView([39, -106.5], 6);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);

        tracksLayer.addTo(map);
        markersLayer.addTo(map);
        cdtLayer.addTo(map);

        fetch("history.json?" + new Date().getTime())
          .then((res) => res.json())
          .then((history) => {
            const latestPoint = history[history.length - 1];

            setTimeout(() => {
              map.removeLayer(tracksLayer);
              map.removeLayer(markersLayer);
              map.removeLayer(cdtLayer);

              map.flyTo([latestPoint.lat, latestPoint.lon], 12, {
                duration: 2,
                easeLinearity: 0.25
              });

              setTimeout(() => {
                map.addLayer(tracksLayer);
                map.addLayer(markersLayer);
                map.addLayer(cdtLayer);
              }, 2000);
            }, 1000);

            fetch("gpx-files.json?" + new Date().getTime())
              .then((res) => res.json())
              .then((gpxFiles) => {
                const cdtFile = gpxFiles.find((f) => f.includes("cdt.gpx"));
                if (!cdtFile) return;

                fetch("gpx/" + cdtFile)
                  .then((res) => res.text())
                  .then((gpxText) => {
                    const gpxParser = new DOMParser();
                    const gpxDoc = gpxParser.parseFromString(
                      gpxText,
                      "application/xml"
                    );
                    const trkpts = Array.from(
                      gpxDoc.querySelectorAll("trkpt")
                    ).map((pt) => [
                      parseFloat(pt.getAttribute("lat")),
                      parseFloat(pt.getAttribute("lon"))
                    ]);

                    function haversine(coord1, coord2) {
                      const R = 6371000;
                      const toRad = (x) => (x * Math.PI) / 180;
                      const dLat = toRad(coord2[0] - coord1[0]);
                      const dLon = toRad(coord2[1] - coord1[1]);
                      const lat1 = toRad(coord1[0]);
                      const lat2 = toRad(coord2[0]);

                      const a =
                        Math.sin(dLat / 2) ** 2 +
                        Math.sin(dLon / 2) ** 2 *
                          Math.cos(lat1) *
                          Math.cos(lat2);
                      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                      return R * c;
                    }

                    const cumulativeDistances = [0];
                    for (let i = 1; i < trkpts.length; i++) {
                      const dist = haversine(trkpts[i - 1], trkpts[i]);
                      cumulativeDistances.push(
                        cumulativeDistances[i - 1] + dist
                      );
                    }

                    let minDist = Infinity;
                    let closestIndex = 0;
                    trkpts.forEach((pt, i) => {
                      const d = haversine(pt, [
                        latestPoint.lat,
                        latestPoint.lon
                      ]);
                      if (d < minDist) {
                        minDist = d;
                        closestIndex = i;
                      }
                    });

                    const percentComplete =
                      (cumulativeDistances[closestIndex] /
                        cumulativeDistances[cumulativeDistances.length - 1]) *
                      100;

                    document.getElementById("progress-percent").textContent =
                      percentComplete.toFixed(2) + "%";
                    document.getElementById("progress-fill").style.width =
                      percentComplete + "%";

                    const stateSegments = getStateSegments(trkpts);
                    const stateProgress = calculateStateProgress(
                      stateSegments,
                      trkpts,
                      cumulativeDistances,
                      closestIndex
                    );

                    for (const [state, progress] of Object.entries(
                      stateProgress
                    )) {
                      const stateCode = state.toLowerCase();
                      document.getElementById(
                        `${stateCode}-percent`
                      ).textContent = progress.toFixed(2) + "%";
                      document.getElementById(`${stateCode}-fill`).style.width =
                        progress + "%";
                    }
                  });
              });

            const pointsByDay = history.reduce((groups, point) => {
              const mdtDateStr = getMDTDateString(point.time);
              if (!groups[mdtDateStr]) {
                groups[mdtDateStr] = [];
              }
              groups[mdtDateStr].push(point);
              return groups;
            }, {});

            Object.entries(pointsByDay).forEach(([mdtDateStr, points]) => {
              const dayColor = generateDayColor(new Date(mdtDateStr));

              points.forEach((point) => {
                const localDate = new Date(point.time);
                const formattedDate = localDate.toLocaleDateString("en-GB");
                const dayNumber = getDaysSinceStart(point.time);
                const popupContent = `
                  <b>Day ${dayNumber}</b><br>
                  <b>Time:</b> ${formattedDate} ${localDate.toLocaleTimeString()}<br>
                  <b>Latitude:</b> ${point.lat.toFixed(6)}<br>
                  <b>Longitude:</b> ${point.lon.toFixed(6)}<br>
                  <b>Elevation:</b> ${point.elev || "N/A"}<br>
                  <b>Velocity:</b> ${point.velo || "N/A"}
                `;

                const isLatest = point === latestPoint;
                const icon = L.divIcon({
                  className: "leaflet-div-icon",
                  html: isLatest
                    ? `<i class="fas fa-map-marker-alt" style="color: orange; font-size: ${
                        window.innerWidth <= 768 ? "32px" : "24px"
                      };"></i>`
                    : `<div style="
          width: ${window.innerWidth <= 768 ? "12px" : "8px"};
          height: ${window.innerWidth <= 768 ? "12px" : "8px"};
          background-color: ${dayColor};
          border-radius: 50%;
        "></div>`,
                  iconSize: isLatest ? [32, 32] : [18, 18],
                  iconAnchor: isLatest ? [16, 32] : [9, 9],
                  popupAnchor: [0, isLatest ? -32 : -9]
                });

                L.marker([point.lat, point.lon], { icon })
                  .bindPopup(popupContent)
                  .addTo(markersLayer);
              });

              const dayPolyline = points.map((p) => [p.lat, p.lon]);
              L.polyline(dayPolyline, {
                color: dayColor,
                weight: 3,
                opacity: 0.7
              }).addTo(tracksLayer);
            });
          });

        const STATE_BORDERS = {
          NM_CO: 37.0,
          CO_WY: 41.0,
          WY_MT: 45.0
        };

        function getStateSegments(trkpts) {
          const segments = {
            NM: [],
            CO: [],
            WY: [],
            MT: []
          };

          trkpts.forEach((pt, idx) => {
            const lat = pt[0];
            if (lat < STATE_BORDERS.NM_CO) {
              segments.NM.push(idx);
            } else if (lat < STATE_BORDERS.CO_WY) {
              segments.CO.push(idx);
            } else if (lat < STATE_BORDERS.WY_MT) {
              segments.WY.push(idx);
            } else {
              segments.MT.push(idx);
            }
          });

          return segments;
        }

        function calculateStateProgress(
          stateSegments,
          trkpts,
          cumulativeDistances,
          closestIndex
        ) {
          const progress = {};

          for (const [state, indices] of Object.entries(stateSegments)) {
            if (indices.length === 0) continue;

            const stateStart = indices[0];
            const stateEnd = indices[indices.length - 1];
            const stateDistance =
              cumulativeDistances[stateEnd] - cumulativeDistances[stateStart];

            let stateProgress = 0;
            if (closestIndex >= stateEnd) {
              stateProgress = 100;
            } else if (closestIndex >= stateStart) {
              const completedDistance =
                cumulativeDistances[closestIndex] -
                cumulativeDistances[stateStart];
              stateProgress = (completedDistance / stateDistance) * 100;
            }

            progress[state] = stateProgress;
          }

          return progress;
        }

        function getMDTDateString(timestamp) {
          return new Date(
            new Date(timestamp).toLocaleString("en-US", {
              timeZone: "America/Denver"
            })
          ).toDateString();
        }

        const trackColors = [
          "#FF5733", // Orange-red
          "#33FF57", // Lime green
          "#FF33F6", // Pink
          "#33FFF6", // Cyan
          "#F6FF33", // Yellow
          "#9933FF", // Purple
          "#FF8C33", // Light orange
          "#33FFB8", // Turquoise
          "#FF3369" // Rose
        ];

        function generateDayColor(date) {
          const dateStr = date.toDateString();
          let hash = 0;
          for (let i = 0; i < dateStr.length; i++) {
            hash = dateStr.charCodeAt(i) + ((hash << 5) - hash);
          }

          const h = hash % 360;
          return `hsl(${h}, 70%, 50%)`;
        }

        function formatTrackName(filename) {
          return filename
            .replace(".gpx", "")
            .split("-")
            .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
            .join(" ");
        }

        function getDaysSinceStart(timestamp) {
          const startDate = new Date("2025-04-13");
          const pointDate = new Date(timestamp);
          const diffTime = pointDate - startDate;
          const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
          return diffDays + 1; // Add 1 to make it 1-based (Day 1 instead of Day 0)
        }

        fetch("gpx-files.json?" + new Date().getTime())
          .then((response) => response.json())
          .then((gpxFiles) => {
            const legend = L.control({ position: "bottomright" });

            legend.onAdd = function (map) {
              const div = L.DomUtil.create("div", "legend");

              const contentDiv = document.createElement("div");
              contentDiv.className = "legend-content";

              const minimizeBtn = document.createElement("button");
              minimizeBtn.className = "minimize-btn";
              minimizeBtn.setAttribute("aria-label", "Minimize Legend");
              minimizeBtn.innerHTML = '<i class="fas fa-minus"></i>';
              div.appendChild(minimizeBtn);

              const header = document.createElement("h4");
              header.textContent = "Tracks";
              contentDiv.appendChild(header);

              gpxFiles.forEach((file, index) => {
                const color =
                  file === "cdt.gpx"
                    ? "#3357FF"
                    : trackColors[index % trackColors.length];
                const name = formatTrackName(file);

                const entry = document.createElement("div");
                const colorBar = document.createElement("i");
                colorBar.style.background = color;
                entry.appendChild(colorBar);
                entry.appendChild(document.createTextNode(name));
                contentDiv.appendChild(entry);
              });

              div.appendChild(contentDiv);

              L.DomEvent.disableClickPropagation(div);
              L.DomEvent.disableScrollPropagation(div);

              minimizeBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                div.classList.remove("visible");
                document
                  .getElementById("legend-toggle")
                  ?.classList.remove("hidden");
              });

              return div;
            };

            legend.addTo(map);

            gpxFiles.forEach((file, index) => {
              const color =
                file === "cdt.gpx"
                  ? "#3357FF"
                  : trackColors[index % trackColors.length];
              const targetLayer = file === "cdt.gpx" ? cdtLayer : tracksLayer;

              omnivore
                .gpx(
                  `gpx/${file}`,
                  null,
                  L.geoJson(null, {
                    filter: function (feature) {
                      return feature.geometry.type !== "Point";
                    }
                  })
                )
                .on("ready", function () {
                  this.setStyle({
                    color: color,
                    weight: file === "cdt.gpx" ? 2 : 3,
                    opacity: 0.7
                  });
                  targetLayer.addLayer(this);
                });
            });
          })
          .catch((error) => console.error("Error loading GPX files:", error));

        if (window.innerWidth <= 768) {
          const progressToggle = document.getElementById("progress-toggle");
          const legendToggle = document.getElementById("legend-toggle");
          const progressContainer =
            document.getElementById("progress-container");

          if (!progressToggle || !legendToggle || !progressContainer) {
            console.error("Missing required elements for mobile toggles");
            return;
          }

          const progressMinBtn =
            progressContainer.querySelector(".minimize-btn");
          progressMinBtn?.addEventListener("click", () => {
            progressContainer.classList.remove("visible");
            progressToggle.classList.remove("hidden");
          });

          progressToggle.addEventListener("click", () => {
            progressContainer.classList.toggle("visible");
            progressToggle.classList.add("hidden");
            const legendContainer = document.querySelector(".legend");
            if (progressContainer.classList.contains("visible")) {
              legendContainer?.classList.remove("visible");
              legendToggle.classList.remove("hidden");
            }
          });

          legendToggle.addEventListener("click", () => {
            const legendContainer = document.querySelector(".legend");
            if (legendContainer) {
              legendContainer.classList.toggle("visible");
              legendToggle.classList.add("hidden");
              if (legendContainer.classList.contains("visible")) {
                progressContainer.classList.remove("visible");
                progressToggle.classList.remove("hidden");
              }
            }
          });

          map.addEventListener("click", () => {
            progressContainer.classList.remove("visible");
            document.querySelector(".legend")?.classList.remove("visible");
            progressToggle.classList.remove("hidden");
            legendToggle.classList.remove("hidden");
          });
        }
      });
    </script>
  </body>
</html>
